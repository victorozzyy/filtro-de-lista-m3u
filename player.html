<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Player</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      height: 100%; 
      background: #000; 
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    
    #video { 
      width: 100%; 
      height: 100%; 
      background: #000; 
      display: block;
    }
    
    #controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      background: rgba(0,0,0,0.8);
      padding: 15px 20px;
      border-radius: 10px;
      transition: opacity 0.5s ease;
      z-index: 100;
    }
    
    #controls.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    button {
      background: #333;
      color: white;
      border: 2px solid transparent;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    button:hover {
      background: #555;
      border-color: #6bff6b;
    }
    
    button:focus {
      outline: none;
      border-color: #6bff6b;
      background: #555;
    }
    
    button.close {
      background: #c00;
    }
    
    button.close:hover {
      background: #e00;
    }
    
    #channelInfo {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #6bff6b;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 20px;
      font-weight: bold;
      transition: opacity 0.5s ease;
      z-index: 100;
      text-align: center;
      max-width: 80%;
    }
    
    #channelInfo.hidden {
      opacity: 0;
    }
    
    #clock {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      z-index: 100;
    }
    
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 30px 40px;
      border-radius: 10px;
      font-size: 24px;
      color: #6bff6b;
      z-index: 1000;
      display: none;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #333;
      border-top-color: #6bff6b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <video id="video" controls playsinline></video>
  
  <div id="channelInfo">üì∫ Carregando...</div>
  <div id="clock">00:00:00</div>
  <div id="loading">‚è≥ Carregando canal...<span class="spinner"></span></div>
  
  <div id="controls">
    <button id="playPauseBtn" title="Play/Pause">‚ñ∂Ô∏è Play</button>
    <button id="rewBtn" title="Retroceder 10s">‚™™ -10s</button>
    <button id="fwdBtn" title="Avan√ßar 10s">‚©© +10s</button>
    <button id="reloadBtn" title="Recarregar">üîÑ Reload</button>
    <button id="closeBtn" class="close" title="Fechar">‚úñ Fechar</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // ==================== CONFIGURA√á√ÉO ====================
    const video = document.getElementById('video');
    const channelInfo = document.getElementById('channelInfo');
    const controls = document.getElementById('controls');
    const loading = document.getElementById('loading');
    const playPauseBtn = document.getElementById('playPauseBtn');
    
    const params = new URLSearchParams(window.location.search);
    const url = params.get('url') || '';
    const name = params.get('name') || 'Canal';
    const index = parseInt(params.get('index') || '0');
    
    let hls = null;
    let hideControlsTimeout = null;
    
    // ==================== FUN√á√ïES PRINCIPAIS ====================
    
    function showLoading(show = true) {
      loading.style.display = show ? 'block' : 'none';
    }
    
    function showControls(duration = 4000) {
      controls.classList.remove('hidden');
      channelInfo.classList.remove('hidden');
      
      clearTimeout(hideControlsTimeout);
      if (duration > 0) {
        hideControlsTimeout = setTimeout(() => {
          controls.classList.add('hidden');
          channelInfo.classList.add('hidden');
        }, duration);
      }
    }
    
    function updateChannelInfo() {
      channelInfo.textContent = `üì∫ ${name}`;
    }
    
    function loadChannel() {
      if (!url) {
        alert('‚ùå URL do canal n√£o fornecida');
        return;
      }
      
      showLoading(true);
      updateChannelInfo();
      console.log('üé¨ Carregando canal:', name, url);
      
      // Detecta HTTPS com IP direto e converte para HTTP
      let finalUrl = url;
      if (/^https:\/\/\d+\.\d+\.\d+\.\d+/.test(url)) {
        console.warn('‚ö†Ô∏è HTTPS com IP detectado, convertendo para HTTP');
        finalUrl = url.replace('https://', 'http://');
      }
      
      try {
        // Limpar player anterior
        if (hls) {
          hls.destroy();
          hls = null;
        }
        video.pause();
        video.src = '';
        
        if (finalUrl.toLowerCase().includes('.m3u8')) {
          // Usar HLS.js para streams
          if (window.Hls && Hls.isSupported()) {
            console.log('üì∫ Usando HLS.js');
            hls = new Hls({
              enableWorker: true,
              lowLatencyMode: false,
              backBufferLength: 90
            });
            
            hls.loadSource(finalUrl);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
              console.log('‚úÖ Manifest carregado');
              showLoading(false);
              video.play().catch(err => {
                console.warn('‚ö†Ô∏è Autoplay bloqueado:', err);
                showControls(0); // Mant√©m controles vis√≠veis
              });
            });
            
            hls.on(Hls.Events.ERROR, (event, data) => {
              console.error('‚ùå Erro HLS:', data);
              showLoading(false);
              
              if (data.fatal) {
                switch(data.type) {
                  case Hls.ErrorTypes.NETWORK_ERROR:
                    console.log('üîÑ Tentando recuperar erro de rede...');
                    hls.startLoad();
                    break;
                  case Hls.ErrorTypes.MEDIA_ERROR:
                    console.log('üîÑ Tentando recuperar erro de m√≠dia...');
                    hls.recoverMediaError();
                    break;
                  default:
                    alert('‚ùå Erro fatal ao carregar stream');
                    break;
                }
              }
            });
          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari nativo
            console.log('üçé Usando player nativo Safari');
            video.src = finalUrl;
            video.load();
            video.play().then(() => {
              showLoading(false);
            }).catch(err => {
              console.warn('‚ö†Ô∏è Autoplay bloqueado:', err);
              showLoading(false);
              showControls(0);
            });
          } else {
            alert('‚ùå HLS.js n√£o suportado neste navegador');
            showLoading(false);
          }
        } else {
          // MP4 ou outros formatos
          console.log('üé¨ Usando HTML5 Video');
          video.src = finalUrl;
          video.load();
          
          video.addEventListener('loadedmetadata', () => {
            console.log('‚úÖ V√≠deo carregado');
            showLoading(false);
            video.play().catch(err => {
              console.warn('‚ö†Ô∏è Autoplay bloqueado:', err);
              showControls(0);
            });
          }, { once: true });
          
          video.addEventListener('error', (e) => {
            console.error('‚ùå Erro ao carregar v√≠deo:', video.error);
            showLoading(false);
            
            let errorMsg = '‚ùå N√£o foi poss√≠vel carregar o v√≠deo.\n\n';
            
            if (video.error.code === 4) {
              errorMsg += 'üîí Poss√≠vel problema de certificado SSL.\n\n';
              errorMsg += 'Tente abrir esta URL diretamente:\n' + finalUrl.substring(0, 60) + '...';
            } else {
              errorMsg += 'C√≥digo de erro: ' + video.error.code;
            }
            
            alert(errorMsg);
          }, { once: true });
        }
      } catch (error) {
        console.error('Erro ao inicializar player:', error);
        showLoading(false);
        alert('‚ùå Erro: ' + error.message);
      }
    }
    
    // ==================== CONTROLES ====================
    
    function togglePlayPause() {
      if (video.paused) {
        video.play();
        playPauseBtn.textContent = '‚è∏ Pause';
      } else {
        video.pause();
        playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
      }
    }
    
    function seek(seconds) {
      video.currentTime = Math.max(0, Math.min(video.currentTime + seconds, video.duration || 0));
    }
    
    function reload() {
      loadChannel();
    }
    
    function closePlayer() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      video.pause();
      
      // Tenta fechar a aba
      try {
        window.close();
      } catch (e) {
        // Se n√£o conseguir fechar, volta para a p√°gina anterior
        if (document.referrer) {
          window.location.href = document.referrer;
        } else {
          alert('‚ÑπÔ∏è Feche esta aba manualmente');
        }
      }
    }
    
    // ==================== EVENT LISTENERS ====================
    
    // Bot√µes
    playPauseBtn.addEventListener('click', togglePlayPause);
    document.getElementById('rewBtn').addEventListener('click', () => seek(-10));
    document.getElementById('fwdBtn').addEventListener('click', () => seek(10));
    document.getElementById('reloadBtn').addEventListener('click', reload);
    document.getElementById('closeBtn').addEventListener('click', closePlayer);
    
    // Atualizar bot√£o play/pause
    video.addEventListener('play', () => {
      playPauseBtn.textContent = '‚è∏ Pause';
    });
    
    video.addEventListener('pause', () => {
      playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
      showControls(0); // Mant√©m controles vis√≠veis quando pausado
    });
    
    // Auto pr√≥ximo para MP4
    video.addEventListener('ended', () => {
      console.log('üîÑ V√≠deo terminou');
      if (url.toLowerCase().endsWith('.mp4')) {
        // Poderia implementar pr√≥ximo canal aqui se tivesse playlist
        showControls(0);
      }
    });
    
    // Mostrar controles
    document.addEventListener('mousemove', () => showControls());
    video.addEventListener('click', () => showControls());
    
    // Teclado
    document.addEventListener('keydown', (e) => {
      switch(e.key) {
        case ' ':
        case 'Enter':
          e.preventDefault();
          togglePlayPause();
          showControls();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          seek(-10);
          showControls();
          break;
        case 'ArrowRight':
          e.preventDefault();
          seek(10);
          showControls();
          break;
        case 'Escape':
        case 'Backspace':
          e.preventDefault();
          closePlayer();
          break;
        case 'r':
        case 'R':
          e.preventDefault();
          reload();
          showControls();
          break;
      }
      
      // C√≥digos de tecla do controle remoto Tizen
      if (e.keyCode === 10009) { // Return/Back key
        e.preventDefault();
        closePlayer();
      }
    });
    
    // ==================== REL√ìGIO ====================
    
    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('clock').textContent = `${h}:${m}:${s}`;
    }
    
    setInterval(updateClock, 1000);
    updateClock();
    
    // ==================== INICIALIZA√á√ÉO ====================
    
    showControls(5000);
    loadChannel();
    
    console.log('üöÄ Player inicializado');
    console.log('üì∫ Canal:', name);
    console.log('üîó URL:', url);
    console.log('üìç √çndice:', index);
  </script>
</body>
</html>
